From 1345959e285c8d2343d87121f5f3a17563f0cc1a Mon Sep 17 00:00:00 2001
From: Priit Laes <plaes@plaes.org>
Date: Tue, 20 Dec 2011 15:42:44 +0200
Subject: [PATCH] Split support for libsoup-gnome

https://bugzilla.gnome.org/show_bug.cgi?id=595065

Original patch by Romain Perier.
---
 Makefile.am         | 12 +++++++++--
 configure.ac        |  9 ++++++++
 libsoup/Makefile.am | 60 +++++++++++++++++++++++++++++++++++++++--------------
 3 files changed, 63 insertions(+), 18 deletions(-)

diff --git a/Makefile.am b/Makefile.am
index 66992d9..787b3d6 100644
--- a/Makefile.am
+++ b/Makefile.am
@@ -1,7 +1,11 @@
 ## Process this file with automake to produce Makefile.in
 ACLOCAL_AMFLAGS = -I m4 ${ACLOCAL_FLAGS}
 
-SUBDIRS = libsoup po tests examples docs
+SUBDIRS = libsoup
+
+if BUILD_LIBSOUP
+SUBDIRS += po tests examples docs
+endif
 
 EXTRA_DIST =				\
 	data/effective_tld_names.dat	\
@@ -16,7 +20,11 @@ DISTCHECK_CONFIGURE_FLAGS = --enable-gtk-doc --enable-introspection
 
 pkgconfigdir = $(libdir)/pkgconfig
 
-pkgconfig_DATA = libsoup-2.4.pc
+pkgconfig_DATA =
+
+if BUILD_LIBSOUP
+pkgconfig_DATA += libsoup-2.4.pc
+endif
 
 if BUILD_LIBSOUP_GNOME
 pkgconfig_DATA += libsoup-gnome-2.4.pc
diff --git a/configure.ac b/configure.ac
index 34db367..c5a7075 100644
--- a/configure.ac
+++ b/configure.ac
@@ -76,6 +76,11 @@ LT_INIT([win32-dll])
 dnl ***********************
 dnl *** Checks for glib ***
 dnl ***********************
+PKG_PROG_PKG_CONFIG
+AC_ARG_WITH(libsoup-system,
+   AS_HELP_STRING([--with-libsoup-system], [Use libsoup system library to build(default=no)]),
+   [with_libsoup_system=$withval], [with_libsoup_system=no])
+AM_CONDITIONAL(BUILD_LIBSOUP, test $with_libsoup_system = no)
 
 GLIB_REQUIRED=2.35.0
 AM_PATH_GLIB_2_0($GLIB_REQUIRED,,,gobject gio)
@@ -138,6 +143,10 @@ AM_CONDITIONAL(BUILD_LIBSOUP_GNOME, test $with_gnome != no)
 
 if test $with_gnome != no; then
 	AC_DEFINE(HAVE_GNOME, 1, [Defined if GNOME support is enabled])
+
+	if test $with_libsoup_system != no; then
+		PKG_CHECK_MODULES(LIBSOUP, libsoup-$SOUP_API_VERSION = $VERSION)
+	fi
 fi
 AC_SUBST(HAVE_GNOME)
 
diff --git a/libsoup/Makefile.am b/libsoup/Makefile.am
index e99c8e6..6bebec8 100644
--- a/libsoup/Makefile.am
+++ b/libsoup/Makefile.am
@@ -1,18 +1,22 @@
 ## Process this file with automake to produce Makefile.in
 
 EXTRA_DIST =
-
+BUILT_SOURCES =
 include $(GLIB_MAKEFILE)
 
-INCLUDES = 				\
+INCLUDES =
+lib_LTLIBRARIES =
+CLEANFILES =
+
+if BUILD_LIBSOUP
+INCLUDES += 				\
 	-DG_LOG_DOMAIN=\"libsoup\" 	\
 	-DLOCALEDIR=\"$(localedir)\"	\
 	-I$(top_srcdir)			\
 	-I$(top_builddir)		\
 	$(SOUP_DEBUG_FLAGS)		\
 	$(GLIB_CFLAGS)			\
-	$(XML_CFLAGS)			\
-	$(SQLITE_CFLAGS)
+	$(XML_CFLAGS)
 
 libsoupincludedir = $(includedir)/libsoup-2.4/libsoup
 
@@ -72,7 +76,7 @@ libsoupinclude_HEADERS =	\
 nodist_libsoupinclude_HEADERS =	\
 	soup-version.h
 
-lib_LTLIBRARIES = libsoup-2.4.la
+lib_LTLIBRARIES += libsoup-2.4.la
 
 libsoup_2_4_la_LDFLAGS =	\
 	-version-info $(SOUP_CURRENT):$(SOUP_REVISION):$(SOUP_AGE) \
@@ -181,18 +185,24 @@ libsoup_2_4_la_SOURCES =		\
 	soup-version.c			\
 	soup-xmlrpc.c
 
-# TLD rules
-EXTRA_DIST += tld-parser.py
-
+BUILT_SOURCES = tld_data.inc
 TLD_DATA_FILE=$(top_srcdir)/data/effective_tld_names.dat
 
 tld_data.inc: tld-parser.py $(TLD_DATA_FILE)
 	$(srcdir)/tld-parser.py $(TLD_DATA_FILE) tld_data.inc
 
+# TLD rules
+EXTRA_DIST += tld-parser.py
+
+endif
+
 if BUILD_LIBSOUP_GNOME
 
 libsoupgnomeincludedir = $(includedir)/libsoup-gnome-2.4/libsoup
 
+INCLUDES += $(LIBSOUP_CFLAGS)		\
+    $(SQLITE_CFLAGS)
+
 libsoupgnomeinclude_HEADERS =	\
 	soup-cookie-jar-sqlite.h\
 	soup-gnome.h		\
@@ -200,17 +210,26 @@ libsoupgnomeinclude_HEADERS =	\
 
 lib_LTLIBRARIES += libsoup-gnome-2.4.la
 
+if BUILD_LIBSOUP
+libsoup_gnome_2_4_la_LDFLAGS = $(libsoup_2_4_la_LDFLAGS)
+else
 libsoup_gnome_2_4_la_LDFLAGS =	\
 	-version-info $(SOUP_CURRENT):$(SOUP_REVISION):$(SOUP_AGE) \
 	-no-undefined \
 	-export-symbols $(srcdir)/libsoup-gnome-2.4.sym
 
 EXTRA_DIST += libsoup-gnome-2.4.sym
+endif
 
 libsoup_gnome_2_4_la_LIBADD =		\
-	libsoup-2.4.la			\
 	$(GLIB_LIBS)
 
+if BUILD_LIBSOUP
+libsoup_gnome_2_4_la_LIBADD += libsoup-2.4.la
+else
+libsoup_gnome_2_4_la_LIBADD += $(LIBSOUP_LIBS)
+endif
+
 libsoup_gnome_2_4_la_SOURCES =		\
 	soup-cookie-jar-sqlite.c	\
 	soup-gnome-features.c		\
@@ -223,9 +242,8 @@ endif
 
 GLIB_GENERATED = soup-marshal.c soup-marshal.h
 GLIB_GENERATED += soup-enum-types.c soup-enum-types.h
-BUILT_SOURCES = \
-	$(GLIB_GENERATED)   \
-	tld_data.inc
+BUILT_SOURCES += \
+	$(GLIB_GENERATED)
 
 soup_marshal_sources = $(libsoup_2_4_la_SOURCES) $(libsoup_gnome_2_4_la_SOURCES)
 soup_enum_types_sources = $(libsoupinclude_HEADERS) $(libsoupgnomeinclude_HEADERS)
@@ -241,6 +259,8 @@ INTROSPECTION_COMPILER_ARGS = --includedir=.
 
 if HAVE_INTROSPECTION
 
+if BUILD_LIBSOUP
+
 # Core library
 gi_soup_files = \
 	$(filter-out soup.h soup-enum-types.% soup-marshal.% soup-proxy-resolver.h,\
@@ -262,20 +282,28 @@ Soup_2_4_gir_FILES = \
 
 INTROSPECTION_GIRS += Soup-2.4.gir
 
+endif
+
 if BUILD_LIBSOUP_GNOME
 
+if BUILD_LIBSOUP
+SOUP_GIR = Soup-2.4.gir
+else
+SOUP_GIR =
+endif
+
 # GNOME extensions
 gi_soup_gnome_files = $(filter-out soup-gnome.h,\
 		          $(libsoupgnomeinclude_HEADERS) \
 	                  $(filter-out %.h, $(libsoup_gnome_2_4_la_SOURCES)))
-SoupGNOME-2.4.gir: libsoup-gnome-2.4.la Soup-2.4.gir
+SoupGNOME-2.4.gir: libsoup-gnome-2.4.la $(SOUP_GIR)
+SoupGNOME_2_4_gir_INCLUDES = Soup-2.4
 SoupGNOME_2_4_gir_SCANNERFLAGS =			\
 	--identifier-prefix=Soup			\
 	--symbol-prefix=soup				\
-	--c-include "libsoup/soup-gnome.h"		\
-	--include-uninstalled=$(builddir)/Soup-2.4.gir
+	--c-include "libsoup/soup-gnome.h"
 SoupGNOME_2_4_gir_CFLAGS = $(INCLUDES)
-SoupGNOME_2_4_gir_LIBS = libsoup-gnome-2.4.la libsoup-2.4.la
+SoupGNOME_2_4_gir_LIBS = libsoup-gnome-2.4.la
 SoupGNOME_2_4_gir_FILES = $(addprefix $(srcdir)/,$(gi_soup_gnome_files))
 SoupGNOME_2_4_gir_EXPORT_PACKAGES = libsoup-gnome-2.4
 
-- 
1.8.1.5

