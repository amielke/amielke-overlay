Index: WebCore/ChangeLog
===================================================================
--- WebCore/ChangeLog	(revision 61617)
+++ WebCore/ChangeLog	(working copy)
@@ -1,3 +1,35 @@
+2010-06-22  Andras Becsi  <abecsi@webkit.org>
+
+        Reviewed by NOBODY (OOPS!).
+
+        Refactor gperf code generation and usage to fix the debug build with gcc>4.4.
+        webkit.org/b/29244
+
+        Hitherto gperf generated C code, these files were included in multiple C++ files across WebCore
+        to access the functionality provided. This resulted in debug build failure with newer gcc versions
+        because of a behaviour change of gcc, which disables C style inlining in debug mode.
+        The make-hash-tools.pl script lets gperf generate C++ code for all gperf files now, which are compiled
+        in their own compilation unit.
+        The functionality provided by the generated code is wrapped behind HashTools.h, so there is no need
+        for multiple inclusions of generated C files to access these functions.
+
+        No new functionality added, no new tests needed.
+
+        * WebCore.pri:
+        * WebCore.xcodeproj/project.pbxproj:
+        * css/CSSParser.cpp:
+        * css/makeprop.pl:
+        * css/makevalues.pl:
+        * html/DocTypeStrings.gperf:
+        * html/HTML5EntityParser.cpp:
+        * html/HTMLDocument.cpp:
+        * html/HTMLDocumentParser.cpp:
+        * html/HTMLEntityNames.gperf:
+        * html/PreloadScanner.cpp:
+        * make-hash-tools.pl:
+        * platform/ColorData.gperf:
+        * platform/graphics/Color.cpp:
+
 2010-06-22  Yuta Kitamura  <yutak@chromium.org>
 
         Reviewed by Alexey Proskuryakov.
Index: WebCore/WebCore.pri
===================================================================
--- WebCore/WebCore.pri	(revision 61617)
+++ WebCore/WebCore.pri	(working copy)
@@ -681,7 +681,7 @@ cssprops.wkScript = $$PWD/css/makeprop.p
 cssprops.output = $${WC_GENERATED_SOURCES_DIR}/CSSPropertyNames.cpp
 cssprops.input = WALDOCSSPROPS
 cssprops.commands = perl -ne \"print lc\" ${QMAKE_FILE_NAME} $${DASHBOARDSUPPORTCSSPROPERTIES} $${EXTRACSSPROPERTIES} > $${WC_GENERATED_SOURCES_DIR}/${QMAKE_FILE_BASE}.in && cd $$WC_GENERATED_SOURCES_DIR && perl $$cssprops.wkScript && $(DEL_FILE) ${QMAKE_FILE_BASE}.in ${QMAKE_FILE_BASE}.gperf
-cssprops.depends = ${QMAKE_FILE_NAME} $${DASHBOARDSUPPORTCSSPROPERTIES} $${EXTRACSSPROPERTIES}
+cssprops.depends = ${QMAKE_FILE_NAME} $${DASHBOARDSUPPORTCSSPROPERTIES} $${EXTRACSSPROPERTIES} $$cssprops.wkScript
 addExtraCompiler(cssprops)
 
 # GENERATOR 6-B:
@@ -689,7 +689,7 @@ cssvalues.wkScript = $$PWD/css/makevalue
 cssvalues.output = $${WC_GENERATED_SOURCES_DIR}/CSSValueKeywords.cpp
 cssvalues.input = WALDOCSSVALUES
 cssvalues.commands = perl -ne \"print lc\" ${QMAKE_FILE_NAME} $$EXTRACSSVALUES > $${WC_GENERATED_SOURCES_DIR}/${QMAKE_FILE_BASE}.in && cd $$WC_GENERATED_SOURCES_DIR && perl $$cssvalues.wkScript && $(DEL_FILE) ${QMAKE_FILE_BASE}.in ${QMAKE_FILE_BASE}.gperf
-cssvalues.depends = ${QMAKE_FILE_NAME} $${EXTRACSSVALUES}
+cssvalues.depends = ${QMAKE_FILE_NAME} $${EXTRACSSVALUES} $$cssvalues.wkScript
 cssvalues.clean = ${QMAKE_FILE_OUT} ${QMAKE_VAR_WC_GENERATED_SOURCES_DIR}/${QMAKE_FILE_BASE}.h
 addExtraCompiler(cssvalues)
 
Index: WebCore/make-hash-tools.pl
===================================================================
--- WebCore/make-hash-tools.pl	(revision 61617)
+++ WebCore/make-hash-tools.pl	(working copy)
@@ -26,35 +26,172 @@ use File::Basename;
 my $outdir = $ARGV[0];
 shift;
 my $option = basename($ARGV[0],".gperf");
+my $hashToolsHeader = "$outdir/HashTools.h";
+
+sub createHashToolsHeader() {
+
+open HEADER, ">$hashToolsHeader" || die "Could not open $hashToolsHeader for writing";
+print HEADER << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+#ifndef HashTools_h
+#define HashTools_h
+
+namespace WebCore {
+
+struct Entity {
+    const char* name;
+    int code;
+};
+
+struct PubIDInfo {
+    enum eMode {
+        eQuirks,
+        eQuirks3,
+        eAlmostStandards
+    };
+
+    const char* name;
+    eMode mode_if_no_sysid;
+    eMode mode_if_sysid;
+};
+
+struct NamedColor {
+    const char* name;
+    int RGBValue;
+};
+
+struct Property {
+    const char* name;
+    int id;
+};
+
+struct Value {
+    const char* name;
+    int id;
+};
+
+const Entity* findEntity(register const char* str, register unsigned int len);
+const PubIDInfo* findDoctypeEntry(register const char* str, register unsigned int len);
+const NamedColor* findColor(register const char* str, register unsigned int len);
+const Property* findProperty(register const char* str, register unsigned int len);
+const Value* findValue(register const char* str, register unsigned int len);
+
+// Needed by Chromium
+const Entity* wordList();
+const int wordListSize();
+
+}
+
+#endif // HashTools_h
+
+EOF
+close HEADER;
+
+}
+
+
 
 switch ($option) {
 
 case "HTMLEntityNames" {
 
-    my $htmlEntityNamesGenerated   = "$outdir/HTMLEntityNames.cpp";
+    createHashToolsHeader();
+
+    my $htmlEntityNamesImpl        = "$outdir/HTMLEntityNames.cpp";
+    my $htmlEntityNamesGenerated   = "$outdir/HTMLEntityNamesHash.hpp";
     my $htmlEntityNamesGperf       = $ARGV[0];
     shift;
 
+    open ENTITIES, ">$htmlEntityNamesImpl" || die "Could not open $htmlEntityNamesImpl for writing";
+    print ENTITIES << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+#include "HashTools.h"
+
+namespace WebCore {
+#include "HTMLEntityNamesHash.hpp"
+
+const Entity* findEntity(register const char* str, register unsigned int len)
+{
+    return HTMLEntityHash::findEntityImpl(str, len);
+}
+
+const Entity* wordList()
+{
+    return WebCore::wordlist;
+}
+
+const int wordListSize()
+{
+    return sizeof(WebCore::wordlist) / sizeof(Entity);
+}
+
+}
+
+EOF
+    close ENTITIES;
+
     system("gperf --key-positions=\"*\" -D -s 2 $htmlEntityNamesGperf > $htmlEntityNamesGenerated") == 0 || die "calling gperf failed: $?";
 
 } # case "HTMLEntityNames"
 
 case "DocTypeStrings" {
 
-    my $docTypeStringsGenerated    = "$outdir/DocTypeStrings.cpp";
+    my $docTypeStringsImpl         = "$outdir/DocTypeStrings.cpp";
+    my $docTypeStringsGenerated    = "$outdir/DocTypeStringsHash.hpp";
     my $docTypeStringsGperf        = $ARGV[0];
     shift;
 
+    open DOCTYPESTRINGS, ">$docTypeStringsImpl" || die "Could not open $docTypeStringsImpl for writing";
+    print DOCTYPESTRINGS << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+#include "HashTools.h"
+
+namespace WebCore {
+#include "DocTypeStringsHash.hpp"
+
+const PubIDInfo* findDoctypeEntry (register const char* str, register unsigned int len)
+{
+    return DocTypeStringsHash::findDoctypeEntryImpl(str, len);
+}
+
+}
+
+EOF
+    close DOCTYPESTRINGS;
+
     system("gperf --key-positions=\"*\" -s 2 $docTypeStringsGperf > $docTypeStringsGenerated") == 0 || die "calling gperf failed: $?";
 
 } # case "DocTypeStrings"
 
 case "ColorData" {
 
-    my $colorDataGenerated   = "$outdir/ColorData.cpp";
-    my $colorDataGperf       = $ARGV[0];
+    my $colorDataImpl              = "$outdir/ColorData.cpp";
+    my $colorDataGenerated         = "$outdir/ColorDataHash.hpp";
+    my $colorDataGperf             = $ARGV[0];
     shift;
 
+    open COLORDATA, ">$colorDataImpl" || die "Could not open $colorDataImpl for writing";
+    print COLORDATA << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+#include "HashTools.h"
+
+namespace WebCore {
+#include "ColorDataHash.hpp"
+
+const struct NamedColor* findColor (register const char* str, register unsigned int len)
+{
+    return ColorDataHash::findColorImpl(str, len);
+}
+
+}
+
+EOF
+    close COLORDATA;
+
     system("gperf --key-positions=\"*\" -D -s 2 $colorDataGperf > $colorDataGenerated") == 0 || die "calling gperf failed: $?";
 
 } # case "ColorData"
Index: WebCore/WebCore.xcodeproj/project.pbxproj
===================================================================
--- WebCore/WebCore.xcodeproj/project.pbxproj	(revision 61617)
+++ WebCore/WebCore.xcodeproj/project.pbxproj	(working copy)
@@ -373,6 +373,11 @@
 		1A569D230D7E2B82007C3983 /* runtime_object.h in Headers */ = {isa = PBXBuildFile; fileRef = 1A569CF40D7E2B82007C3983 /* runtime_object.h */; settings = {ATTRIBUTES = (Private, ); }; };
 		1A569D240D7E2B82007C3983 /* runtime_root.cpp in Sources */ = {isa = PBXBuildFile; fileRef = 1A569CF50D7E2B82007C3983 /* runtime_root.cpp */; };
 		1A569D250D7E2B82007C3983 /* runtime_root.h in Headers */ = {isa = PBXBuildFile; fileRef = 1A569CF60D7E2B82007C3983 /* runtime_root.h */; settings = {ATTRIBUTES = (Private, ); }; };
+		1A676E5D11CFC3E0002F85D5 /* HTMLEntityNames.cpp in Sources */ = {isa = PBXBuildFile; fileRef = E406F4021198329A009D59D6 /* HTMLEntityNames.cpp */; };
+		1A676E5E11CFC3E6002F85D5 /* CSSValueKeywords.cpp in Sources */ = {isa = PBXBuildFile; fileRef = E41EA0391198374900710BC5 /* CSSValueKeywords.cpp */; };
+		1A676E6011CFC3EE002F85D5 /* ColorData.cpp in Sources */ = {isa = PBXBuildFile; fileRef = E406F3FB1198307D009D59D6 /* ColorData.cpp */; };
+		1A676E6111CFC3FB002F85D5 /* CSSPropertyNames.cpp in Sources */ = {isa = PBXBuildFile; fileRef = E41EA038119836DB00710BC5 /* CSSPropertyNames.cpp */; };
+		1A676E6211CFC408002F85D5 /* DocTypeStrings.cpp in Sources */ = {isa = PBXBuildFile; fileRef = E406F3FA1198304D009D59D6 /* DocTypeStrings.cpp */; };
 		1A6938010A11100A00C127FE /* TextDocument.cpp in Sources */ = {isa = PBXBuildFile; fileRef = 1A6937FF0A11100A00C127FE /* TextDocument.cpp */; };
 		1A6938020A11100A00C127FE /* TextDocument.h in Headers */ = {isa = PBXBuildFile; fileRef = 1A6938000A11100A00C127FE /* TextDocument.h */; };
 		1A71D57B0F33819000F9CE4E /* IdentifierRep.cpp in Sources */ = {isa = PBXBuildFile; fileRef = 1A71D5790F33819000F9CE4E /* IdentifierRep.cpp */; };
@@ -21815,6 +21820,11 @@
 				200B190911C277D900DCCD3A /* ScriptBreakpoint.cpp in Sources */,
 				1AD8F81C11CAB9E900E93E54 /* PlatformStrategies.cpp in Sources */,
 				B525A96611CA2340003A23A8 /* JSSQLException.cpp in Sources */,
+				1A676E5D11CFC3E0002F85D5 /* HTMLEntityNames.cpp in Sources */,
+				1A676E5E11CFC3E6002F85D5 /* CSSValueKeywords.cpp in Sources */,
+				1A676E6011CFC3EE002F85D5 /* ColorData.cpp in Sources */,
+				1A676E6111CFC3FB002F85D5 /* CSSPropertyNames.cpp in Sources */,
+				1A676E6211CFC408002F85D5 /* DocTypeStrings.cpp in Sources */,
 			);
 			runOnlyForDeploymentPostprocessing = 0;
 		};
Index: WebCore/css/CSSParser.cpp
===================================================================
--- WebCore/css/CSSParser.cpp	(revision 61617)
+++ WebCore/css/CSSParser.cpp	(working copy)
@@ -61,6 +61,7 @@
 #include "FloatConversion.h"
 #include "FontFamilyValue.h"
 #include "FontValue.h"
+#include "HashTools.h"
 #include "MediaList.h"
 #include "MediaQueryExp.h"
 #include "Pair.h"
@@ -88,9 +89,6 @@ extern int cssyyparse(void* parser);
 using namespace std;
 using namespace WTF;
 
-#include "CSSPropertyNames.cpp"
-#include "CSSValueKeywords.cpp"
-
 namespace WebCore {
 
 static const unsigned INVALID_NUM_PARSED_PROPERTIES = UINT_MAX;
Index: WebCore/css/makeprop.pl
===================================================================
--- WebCore/css/makeprop.pl	(revision 61617)
+++ WebCore/css/makeprop.pl	(working copy)
@@ -41,15 +41,14 @@ print GPERF << "EOF";
 #include \"CSSPropertyNames.h\"
 %}
 %struct-type
-struct Property {
-    const char* name;
-    int id;
-};
-%language=ANSI-C
+struct Property;
+%omit-struct-type
+%language=C++
 %readonly-tables
 %global-table
 %compare-strncmp
-%define lookup-function-name findProperty
+%define class-name CSSPropertyNamesHash
+%define lookup-function-name findPropertyImpl
 %define hash-function-name propery_hash_function
 %define word-array-name property_wordlist
 %includes
@@ -72,6 +71,10 @@ print HEADER << "EOF";
 #ifndef CSSPropertyNames_h
 #define CSSPropertyNames_h
 
+#include <string.h>
+
+namespace WebCore {
+
 enum CSSPropertyID {
     CSSPropertyInvalid = 0,
 EOF
@@ -99,15 +102,17 @@ print HEADER << "EOF";
 
 const char* getPropertyName(CSSPropertyID);
 
+} // namespace WebCore
+
 #endif // CSSPropertyNames_h
 
 EOF
 
 close HEADER;
 
-system("gperf --key-positions=\"*\" -D -n -s 2 CSSPropertyNames.gperf > CSSPropertyNames.cpp") == 0 || die "calling gperf failed: $?";
+system("gperf --key-positions=\"*\" -D -n -s 2 CSSPropertyNames.gperf > CSSPropertyNamesHash.hpp") == 0 || die "calling gperf failed: $?";
 
-open C, ">>CSSPropertyNames.cpp" || die "Could not open CSSPropertyNames.cpp for writing";
+open C, ">>CSSPropertyNamesHash.hpp" || die "Could not open CSSPropertyNamesHash.hpp for writing";
 print C "static const char * const propertyNameStrings[$num] = {\n";
 
 foreach my $name (@names) {
@@ -116,6 +121,29 @@ foreach my $name (@names) {
 
 print C << "EOF";
 };
+
+EOF
+
+close C;
+
+my $propertyNamesImpl = "CSSPropertyNames.cpp";
+
+open PROPERTYNAMES, ">$propertyNamesImpl" || die "Could not open $propertyNamesImpl for writing";
+print PROPERTYNAMES << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+
+#include "CSSPropertyNames.h"
+#include "HashTools.h"
+
+namespace WebCore {
+#include "CSSPropertyNamesHash.hpp"
+
+const Property* findProperty (register const char* str, register unsigned int len)
+{
+    return CSSPropertyNamesHash::findPropertyImpl(str, len);
+}
+
 const char* getPropertyName(CSSPropertyID id)
 {
     if (id < firstCSSProperty)
@@ -125,7 +153,10 @@ const char* getPropertyName(CSSPropertyI
         return 0;
     return propertyNameStrings[index];
 }
+
+} // namespace WebCore
+
 EOF
 
-close C;
+close PROPERTYNAMES;
 
Index: WebCore/css/makevalues.pl
===================================================================
--- WebCore/css/makevalues.pl	(revision 61617)
+++ WebCore/css/makevalues.pl	(working copy)
@@ -42,14 +42,13 @@ print GPERF << "EOF";
 #include \"CSSValueKeywords.h\"
 %}
 %struct-type
-struct Value {
-    const char* name;
-    int id;
-};
-%language=ANSI-C
+struct Value;
+%omit-struct-type
+%language=C++
 %readonly-tables
 %compare-strncmp
-%define lookup-function-name findValue
+%define class-name CSSValueKeywordsHash
+%define lookup-function-name findValueImpl
 %define hash-function-name value_hash_function
 %define word-array-name value_word_list
 %includes
@@ -72,6 +71,10 @@ print HEADER << "EOF";
 #ifndef CSSValueKeywords_h
 #define CSSValueKeywords_h
 
+#include <string.h>
+
+namespace WebCore {
+
 const int CSSValueInvalid = 0;
 EOF
 
@@ -92,13 +95,16 @@ print HEADER << "EOF";
 
 const char* getValueName(unsigned short id);
 
+} // namespace WebCore
+
 #endif // CSSValueKeywords_h
+
 EOF
 close HEADER;
 
-system("gperf --key-positions=\"*\" -D -n -s 2 CSSValueKeywords.gperf > CSSValueKeywords.cpp") == 0 || die "calling gperf failed: $?";
+system("gperf --key-positions=\"*\" -D -n -s 2 CSSValueKeywords.gperf > CSSValueKeywordsHash.hpp") == 0 || die "calling gperf failed: $?";
 
-open C, ">>CSSValueKeywords.cpp" || die "Could not open CSSValueKeywords.cpp for writing";
+open C, ">>CSSValueKeywordsHash.hpp" || die "Could not open CSSValueKeywordsHash.hpp for writing";
 print C  "static const char * const valueList[] = {\n";
 print C  "\"\",\n";
 foreach my $name (@names) {
@@ -107,12 +113,38 @@ foreach my $name (@names) {
 print C << "EOF";
     0
 };
+
+EOF
+
+close C;
+
+my $valueKeywordsImpl = "CSSValueKeywords.cpp";
+
+open VALUEKEYWORDS, ">$valueKeywordsImpl" || die "Could not open $valueKeywordsImpl for writing";
+print VALUEKEYWORDS << "EOF";
+/* This file is automatically generated by make-hash-tools.pl, do not edit */
+
+#include "CSSValueKeywords.h"
+#include "HashTools.h"
+
+namespace WebCore {
+#include "CSSValueKeywordsHash.hpp"
+
+const Value* findValue (register const char* str, register unsigned int len)
+{
+    return CSSValueKeywordsHash::findValueImpl(str, len);
+}
+
 const char* getValueName(unsigned short id)
 {
     if (id >= numCSSValueKeywords || id <= 0)
         return 0;
     return valueList[id];
 }
+
+} // namespace WebCore
+
 EOF
 
-close C;
+close VALUEKEYWORDS;
+
Index: WebCore/html/DocTypeStrings.gperf
===================================================================
--- WebCore/html/DocTypeStrings.gperf	(revision 61617)
+++ WebCore/html/DocTypeStrings.gperf	(working copy)
@@ -1,21 +1,13 @@
 %struct-type
-struct PubIDInfo {
-    enum eMode { 
-        eQuirks,         
-        eQuirks3,       
-        eAlmostStandards
-    };
-
-    const char* name;
-    eMode mode_if_no_sysid;
-    eMode mode_if_sysid;
-}
-%language=ANSI-C
+struct PubIDInfo;
+%omit-struct-type
+%language=C++
 %readonly-tables
 %global-table
 %compare-strncmp
+%define class-name DocTypeStringsHash
 %define initializer-suffix ,PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards
-%define lookup-function-name findDoctypeEntry
+%define lookup-function-name findDoctypeEntryImpl
 %define hash-function-name doctype_hash_function
 %includes
 %enum
Index: WebCore/html/HTML5EntityParser.cpp
===================================================================
--- WebCore/html/HTML5EntityParser.cpp	(revision 61617)
+++ WebCore/html/HTML5EntityParser.cpp	(working copy)
@@ -28,21 +28,9 @@
 #include "config.h"
 #include "HTML5EntityParser.h"
 
+#include "HashTools.h"
 #include <wtf/Vector.h>
 
-// Use __GNUC__ instead of PLATFORM(GCC) to stay consistent with the gperf generated c file
-#ifdef __GNUC__
-// The main parser includes this too so we are getting two copies of the data. However, this way the code gets inlined.
-#include "HTMLEntityNames.cpp"
-#else
-// Not inlined for non-GCC compilers
-struct Entity {
-    const char* name;
-    int code;
-};
-const struct Entity* findEntity(register const char* str, register unsigned int len);
-#endif
-
 using namespace WTF;
 
 namespace WebCore {
Index: WebCore/html/HTMLDocument.cpp
===================================================================
--- WebCore/html/HTMLDocument.cpp	(revision 61617)
+++ WebCore/html/HTMLDocument.cpp	(working copy)
@@ -64,6 +64,7 @@
 #include "FrameLoader.h"
 #include "FrameTree.h"
 #include "FrameView.h"
+#include "HashTools.h"
 #include "HTML5DocumentParser.h"
 #include "HTMLBodyElement.h"
 #include "HTMLElementFactory.h"
@@ -75,8 +76,6 @@
 #include "Settings.h"
 #include <wtf/text/CString.h>
 
-#include "DocTypeStrings.cpp"
-
 namespace WebCore {
 
 using namespace HTMLNames;
Index: WebCore/html/HTMLDocumentParser.cpp
===================================================================
--- WebCore/html/HTMLDocumentParser.cpp	(revision 61617)
+++ WebCore/html/HTMLDocumentParser.cpp	(working copy)
@@ -39,13 +39,14 @@
 #include "Frame.h"
 #include "FrameLoader.h"
 #include "FrameView.h"
+#include "HashTools.h"
 #include "HTMLElement.h"
 #include "HTMLNames.h"
-#include "LegacyHTMLTreeConstructor.h"
 #include "HTMLScriptElement.h"
 #include "HTMLViewSourceDocument.h"
 #include "ImageLoader.h"
 #include "InspectorTimelineAgent.h"
+#include "LegacyHTMLTreeConstructor.h"
 #include "Page.h"
 #include "PreloadScanner.h"
 #include "ScriptController.h"
@@ -55,8 +56,6 @@
 #include <wtf/ASCIICType.h>
 #include <wtf/CurrentTime.h>
 
-#include "HTMLEntityNames.cpp"
-
 #define PRELOAD_SCANNER_ENABLED 1
 
 using namespace WTF;
Index: WebCore/html/HTMLEntityNames.gperf
===================================================================
--- WebCore/html/HTMLEntityNames.gperf	(revision 61617)
+++ WebCore/html/HTMLEntityNames.gperf	(working copy)
@@ -25,15 +25,14 @@
 */
 %}
 %struct-type
-struct Entity {
-    const char *name;
-    int code;
-};
-%language=ANSI-C
+struct Entity;
+%language=C++
+%omit-struct-type
 %readonly-tables
 %global-table
 %compare-strncmp
-%define lookup-function-name findEntity
+%define class-name HTMLEntityHash
+%define lookup-function-name findEntityImpl
 %define hash-function-name entity_hash_function
 %includes
 %enum
Index: WebCore/html/PreloadScanner.cpp
===================================================================
--- WebCore/html/PreloadScanner.cpp	(revision 61617)
+++ WebCore/html/PreloadScanner.cpp	(working copy)
@@ -38,25 +38,13 @@
 #include "Document.h"
 #include "Frame.h"
 #include "FrameLoader.h"
+#include "HashTools.h"
 #include "HTMLLinkElement.h"
 #include "HTMLNames.h"
 #include <wtf/text/CString.h>
 #include <wtf/CurrentTime.h>
 #include <wtf/unicode/Unicode.h>
 
-// Use __GNUC__ instead of PLATFORM(GCC) to stay consistent with the gperf generated c file
-#ifdef __GNUC__
-// The main tokenizer includes this too so we are getting two copies of the data. However, this way the code gets inlined.
-#include "HTMLEntityNames.cpp"
-#else
-// Not inlined for non-GCC compilers
-struct Entity {
-    const char* name;
-    int code;
-};
-const struct Entity* findEntity(register const char* str, register unsigned int len);
-#endif
-
 #define PRELOAD_DEBUG 0
 
 using namespace WTF;
Index: WebCore/platform/ColorData.gperf
===================================================================
--- WebCore/platform/ColorData.gperf	(revision 61617)
+++ WebCore/platform/ColorData.gperf	(working copy)
@@ -1,13 +1,12 @@
 %struct-type
-struct NamedColor {
-    const char *name;
-    int RGBValue;
-};
-%language=ANSI-C
+struct NamedColor;
+%omit-struct-type
+%language=C++
 %readonly-tables
 %global-table
 %compare-strncmp
-%define lookup-function-name findColor
+%define class-name ColorDataHash
+%define lookup-function-name findColorImpl
 %define hash-function-name colordata_hash_function
 %includes
 %enum
Index: WebCore/platform/graphics/Color.cpp
===================================================================
--- WebCore/platform/graphics/Color.cpp	(revision 61617)
+++ WebCore/platform/graphics/Color.cpp	(working copy)
@@ -26,13 +26,12 @@
 #include "config.h"
 #include "Color.h"
 
+#include "HashTools.h"
 #include "PlatformString.h"
 #include <math.h>
 #include <wtf/Assertions.h>
 #include <wtf/MathExtras.h>
 
-#include "ColorData.cpp"
-
 using namespace std;
 using namespace WTF;
 
Index: WebKit/chromium/ChangeLog
===================================================================
--- WebKit/chromium/ChangeLog	(revision 61617)
+++ WebKit/chromium/ChangeLog	(working copy)
@@ -1,3 +1,20 @@
+2010-06-22  Andras Becsi  <abecsi@webkit.org>
+
+        Reviewed by NOBODY (OOPS!).
+
+        Refactor gperf code generation and usage to fix the debug build with gcc>4.4.
+        webkit.org/b/29244
+
+        Hitherto gperf generated C code, these files were included in multiple C++ files across WebCore
+        to access the functionality provided. This resulted in debug build failure with newer gcc versions
+        because of a behaviour change of gcc, which disables C style inlining in debug mode.
+        The make-hash-tools.pl script lets gperf generate C++ code for all gperf files now, which are compiled
+        in their own compilation unit.
+        The functionality provided by the generated code is wrapped behind HashTools.h, so there is no need
+        for multiple inclusions of generated C files to access these functions.
+
+        * src/WebEntities.cpp:
+
 2010-06-22  Mikhail Naganov  <mnaganov@chromium.org>
 
         Reviewed by Pavel Feldman.
Index: WebKit/chromium/src/WebEntities.cpp
===================================================================
--- WebKit/chromium/src/WebEntities.cpp	(revision 61617)
+++ WebKit/chromium/src/WebEntities.cpp	(working copy)
@@ -31,9 +31,9 @@
 #include "config.h"
 #include "WebEntities.h"
 
-#include <string.h>
-
+#include "HashTools.h"
 #include "PlatformString.h"
+#include <string.h>
 #include "StringBuilder.h"
 #include <wtf/HashMap.h>
 
@@ -41,15 +41,6 @@
 
 using namespace WebCore;
 
-namespace {
-// Note that this file is also included by HTMLDocumentParser.cpp so we are getting
-// two copies of the data in memory.  We can fix this by changing the script
-// that generated the array to create a static const that is its length, but
-// this is low priority since the data is less than 4K. We use anonymous
-// namespace to prevent name collisions.
-#include "HTMLEntityNames.cpp" // NOLINT
-}
-
 namespace WebKit {
 
 void populateMap(WTF::HashMap<int, WebCore::String>& map,
@@ -91,8 +82,8 @@ WebEntities::WebEntities(bool xmlEntitie
                     false);
     else
         populateMap(m_entitiesMap,
-                    wordlist,
-                    sizeof(wordlist) / sizeof(Entity),
+                    wordList(),
+                    wordListSize(),
                     true);
 }
 
Index: WebKit/qt/ChangeLog
===================================================================
--- WebKit/qt/ChangeLog	(revision 61617)
+++ WebKit/qt/ChangeLog	(working copy)
@@ -1,3 +1,21 @@
+2010-06-22  Andras Becsi  <abecsi@webkit.org>
+
+        Reviewed by NOBODY (OOPS!).
+
+        Refactor gperf code generation and usage to fix the debug build with gcc>4.4.
+        webkit.org/b/29244
+
+        Hitherto gperf generated C code, these files were included in multiple C++ files across WebCore
+        to access the functionality provided. This resulted in debug build failure with newer gcc versions
+        because of a behaviour change of gcc, which disables C style inlining in debug mode.
+        The make-hash-tools.pl script lets gperf generate C++ code for all gperf files now, which are compiled
+        in their own compilation unit.
+        The functionality provided by the generated code is wrapped behind HashTools.h, so there is no need
+        for multiple inclusions of generated C files to access these functions.
+
+        * WebCoreSupport/FrameLoaderClientQt.cpp:
+        (WebCore::FrameLoaderClientQt::createPlugin):
+
 2010-06-22  Tasuku Suzuki  <tasuku.suzuki@nokia.com>
 
         Reviewed by Simon Hausmann.
Index: WebKit/qt/WebCoreSupport/FrameLoaderClientQt.cpp
===================================================================
--- WebKit/qt/WebCoreSupport/FrameLoaderClientQt.cpp	(revision 61617)
+++ WebKit/qt/WebCoreSupport/FrameLoaderClientQt.cpp	(working copy)
@@ -1322,7 +1322,7 @@ PassRefPtr<Widget> FrameLoaderClientQt::
             for (unsigned i = 0; i < numqStyleSheetProperties; ++i) {
                 CSSPropertyID property = qstyleSheetProperties[i];
 
-                styleSheet += QString::fromLatin1(::getPropertyName(property));
+                styleSheet += QString::fromLatin1(getPropertyName(property));
                 styleSheet += QLatin1Char(':');
                 styleSheet += computedStyle(element)->getPropertyValue(property);
                 styleSheet += QLatin1Cha
